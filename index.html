<!doctype html>
<html lang="pt-br">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat Canvas + GPT</title>
<style>
  :root{--tiffany:#81D8D0;--bg:#0f1216;--card:#151a21;--text:#eaf2fb;--muted:#9fb3c8;--border:#243041}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}

  /* layout principal */
  .grid { display:grid; grid-template-columns:280px 1fr; gap:16px; }

  /* cartão do chat */
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;justify-content:space-between}
  .left{display:flex;gap:8px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--tiffany)}
  .title{font-weight:600}
  .badge{padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#0f172a;font:500 12px system-ui;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  .chat{padding:16px;display:flex;flex-direction:column;gap:10px;height:60vh;overflow:auto}
  .msg{max-width:80%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;white-space:pre-wrap}
  .user{align-self:flex-end;background:rgba(129,216,208,.12)}
  .bot{align-self:flex-start;background:#0d1117}
  .footer{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
  input,button{font:inherit}
  input{flex:1;background:#0d1117;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px}
  button{background:var(--tiffany);border:0;border-radius:10px;padding:10px 16px;color:#0b1f1e;cursor:pointer;font-weight:700}
  button:disabled{opacity:.6;cursor:not-allowed}

  /* botões de upgrade */
  .cta-wrap{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:6px}
  .cta-btn{
    display:inline-block;background:#81D8D0;color:#0b1f1e;
    padding:8px 14px;border-radius:999px;border:0;text-decoration:none;
    font-weight:700; box-shadow:0 1px 3px rgba(0,0,0,.1)
  }
  .cta-btn:hover{filter:brightness(0.95)}

  /* sidebar de histórico */
  .sidebar {
    background: var(--card); border:1px solid var(--border); border-radius:16px;
    padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.25);
    height:60vh; overflow:auto;
  }
  .sidebar header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .sidebar h3 { margin: 6px 0 0; font-size:14px; color: var(--muted); }
  .hist-item {
    border:1px solid var(--border); border-radius:10px; padding:8px; margin-bottom:8px;
    cursor:pointer; background:#0d1117;
  }
  .hist-item:hover { filter: brightness(1.05); }
  .hist-q { color:#bcd2e8; font-weight:600; font-size:13px; margin-bottom:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .hist-a { color:#9fb3c8; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .small-btn {
    background:#223044; color:#eaf2fb; border:1px solid var(--border);
    border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer;
  }
  .small-btn:disabled { opacity:.6; cursor:not-allowed; }
</style>
<body>
  <div class="wrap">
    <div class="grid">
      <!-- Sidebar: Histórico -->
      <aside class="sidebar">
        <header>
          <h3>Histórico (mês)</h3>
          <button id="clear-history" class="small-btn">Limpar</button>
        </header>
        <div id="history-list"></div>
      </aside>

      <!-- Chat -->
      <div class="card">
        <div class="header">
          <div class="left"><span class="dot"></span><div class="title">IA English Journey</div></div>
          <div id="quota-badge" class="badge">carregando…</div>
        </div>
        <div id="chat" class="chat"></div>
        <div class="footer">
          <input id="input" placeholder="Digite sua pergunta..." />
          <button id="send">Enviar</button>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  Importante:
  - URLs RELATIVAS: '/api/chat', '/api/quota', '/api/history'
  - Sempre com credenciais para levar o cookie LTI: credentials: 'include'
*/
const CHAT_URL    = '/api/chat';
const QUOTA_URL   = '/api/quota';
const HISTORY_URL = '/api/history';

const chat   = document.getElementById('chat');
const input  = document.getElementById('input');
const btn    = document.getElementById('send');
const badge  = document.getElementById('quota-badge');

const histList = document.getElementById('history-list');
const clearBtn = document.getElementById('clear-history');

const messages = [
  { role: "system", content: "Você é um tutor de ingles que vai tirar duvidas dos alunos, seja claro e objetivo." }
];

function addMsg(text, who){
  const el = document.createElement('div');
  el.className = `msg ${who}`;
  el.textContent = text;
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
}

/* botões de upgrade */
function addCTAPackages(packages){
  const el = document.createElement('div');
  el.className = 'msg bot';

  const txt = document.createElement('div');
  txt.textContent = 'Você atingiu o limite mensal. Deseja liberar mais mensagens?';

  const wrap = document.createElement('div');
  wrap.className = 'cta-wrap';

  (packages || []).forEach(p => {
    if (!p?.url) return;
    const a = document.createElement('a');
    a.className = 'cta-btn';
    a.href = p.url;
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.textContent = p.label || 'Comprar';
    wrap.appendChild(a);
  });

  el.appendChild(txt);
  el.appendChild(wrap);
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
}

/* QUOTA */
async function atualizarQuota(){
  try {
    const r = await fetch(QUOTA_URL, { credentials: 'include' });
    if (r.status === 401) { badge.textContent = 'entre pelo Canvas'; return; }
    if (!r.ok) throw new Error('quota not ok');
    const { remaining, limit } = await r.json();
    badge.textContent = `Restantes: ${remaining} / ${limit}`;
    if (remaining <= 20) { badge.style.background = '#fff7ed'; badge.style.color = '#9a3412'; }
    else { badge.style.background = '#f1f5f9'; badge.style.color = '#0f172a'; }
  } catch {
    badge.textContent = 'quota indisponível';
  }
}

/* HISTÓRICO */
function fmtTime(ts){
  try {
    const d = new Date(ts);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${dd}/${mm} ${hh}:${mi}`;
  } catch { return ''; }
}

function renderHistory(items){
  histList.innerHTML = '';
  if (!items || items.length === 0) {
    histList.innerHTML = '<div style="color:var(--muted);font-size:12px;">Sem histórico neste mês.</div>';
    return;
  }
  items.forEach(it => {
    const div = document.createElement('div');
    div.className = 'hist-item';
    div.title = new Date(it.ts).toLocaleString();

    const q = document.createElement('div');
    q.className = 'hist-q';
    q.textContent = `(${fmtTime(it.ts)}) ${it.q || ''}`;

    const a = document.createElement('div');
    a.className = 'hist-a';
    a.textContent = it.a || '';

    div.appendChild(q);
    div.appendChild(a);

    // Ao clicar, "reproduz" no chat (só visual para revisão)
    div.addEventListener('click', () => {
      if (it.q) addMsg(it.q, 'user');
      if (it.a) addMsg(it.a, 'bot');
      chat.scrollTop = chat.scrollHeight;
    });

    histList.appendChild(div);
  });
}

async function loadHistory(){
  try {
    const r = await fetch(HISTORY_URL, { credentials: 'include' });
    if (r.status === 401) { renderHistory([]); return; }
    const j = await r.json();
    renderHistory(j.items || []);
  } catch (e) {
    console.error('history load fail', e);
    renderHistory([]);
  }
}

async function clearHistory(){
  if (!confirm('Apagar seu histórico deste mês?')) return;
  clearBtn.disabled = true;
  try {
    const r = await fetch(HISTORY_URL, { method:'DELETE', credentials: 'include' });
    if (r.ok) loadHistory();
  } catch (e) {
    console.error('history clear fail', e);
  } finally {
    clearBtn.disabled = false;
  }
}
clearBtn.addEventListener('click', clearHistory);

/* ENVIO */
async function send(){
  const text = input.value.trim();
  if(!text) return;
  addMsg(text, 'user');
  input.value = '';
  btn.disabled = true;

  messages.push({ role: "user", content: text });

  let data;
  try {
    const res = await fetch(CHAT_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      credentials: "include", // leva cookie lti_user
      body: JSON.stringify({ messages }) // sem streaming
    });

    if (res.status === 429) {
      const j = await res.json().catch(() => ({}));
      addMsg(`Limite mensal atingido (${j.used}/${j.limit}).`, 'bot');

      // mostrar botões de upgrade, se vierem
      if (Array.isArray(j.packages) && j.packages.length > 0) {
        addCTAPackages(j.packages);
      }

      btn.disabled = false;
      await atualizarQuota();
      return;
    }

    if(!res.ok){
      const j = await res.json().catch(() => ({}));
      console.error('Falha /api/chat', res.status, j);
      addMsg("Erro no servidor. Tente novamente.", 'bot');
      btn.disabled = false;
      return;
    }

    data = await res.json();
  } catch (err) {
    console.error('Erro de rede /api/chat:', err);
    addMsg("Erro de rede. Tente novamente.", 'bot');
    btn.disabled = false;
    return;
  }

  const reply = data.reply || "(sem conteúdo)";
  addMsg(reply, 'bot');
  messages.push({ role: "assistant", content: reply });

  btn.disabled = false;
  atualizarQuota();
  loadHistory(); // <-- atualiza a sidebar após cada resposta
}

btn.onclick = send;
input.addEventListener('keydown', e => { if(e.key==='Enter') send(); });

// Ao abrir a página
document.addEventListener('DOMContentLoaded', () => {
  atualizarQuota();
  loadHistory();
});
</script>
</body>
</html>
