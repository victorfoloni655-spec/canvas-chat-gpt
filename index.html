<!doctype html>
<html lang="pt-br">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Chat Canvas + GPT</title>
<style>
  :root{--tiffany:#81D8D0;--bg:#0f1216;--card:#151a21;--text:#eaf2fb;--muted:#9fb3c8;--border:#243041}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:800px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;flex-direction:column;min-height:60vh}
  .header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;justify-content:space-between}
  .left{display:flex;gap:8px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--tiffany)}
  .title{font-weight:600}
  .badge{padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#0f172a;font:500 12px system-ui;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  .chat{padding:16px;display:flex;flex-direction:column;gap:10px;overflow:auto;min-height:240px}
  .msg{max-width:80%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;white-space:pre-wrap}
  .user{align-self:flex-end;background:rgba(129,216,208,.12)}
  .bot{align-self:flex-start;background:#0d1117}
  .footer{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);align-items:center}
  input,button{font:inherit}
  input{
    flex:1;background:#0d1117;color:var(--text);border:1px solid var(--border);
    border-radius:10px;padding:12px 10px;font-size:16px; /* >=16px evita zoom no iOS */
  }
  button{background:var(--tiffany);border:0;border-radius:10px;padding:12px 16px;color:#0b1f1e;cursor:pointer;font-weight:700}
  button:disabled{opacity:.6;cursor:not-allowed}
  /* CTAs de upgrade */
  .cta-wrap{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:6px}
  .cta-btn{
    display:inline-block;background:#81D8D0;color:#0b1f1e;
    padding:8px 14px;border-radius:999px;border:0;text-decoration:none;
    font-weight:700; box-shadow:0 1px 3px rgba(0,0,0,.1)
  }
  .cta-btn:hover{filter:brightness(0.95)}
</style>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="left"><span class="dot"></span><div class="title">IA English Journey</div></div>
        <div id="quota-badge" class="badge">carregando…</div>
      </div>
      <div id="chat" class="chat"></div>
      <div class="footer">
        <input id="input" placeholder="Digite sua pergunta..." autocomplete="off" autocapitalize="sentences" />
        <button id="send">Enviar</button>
      </div>
    </div>
  </div>

<script>
const CHAT_URL  = '/api/chat';
const QUOTA_URL = '/api/quota';

const chat  = document.getElementById('chat');
const input = document.getElementById('input');
const btn   = document.getElementById('send');
const badge = document.getElementById('quota-badge');

/* ---------- TOKEN FALLBACK (funciona em iframe iOS/Android) ---------- */
function captureTokenFromURL(){
  const u = new URL(window.location.href);
  const t = u.searchParams.get('t');
  if (t) {
    localStorage.setItem('lti_token', t);
    // (opcional) remove ?t da URL sem recarregar
    u.searchParams.delete('t');
    window.history.replaceState({}, '', u.toString());
  }
  return t;
}
function getToken(){
  return localStorage.getItem('lti_token') || captureTokenFromURL() || null;
}

/* ---------------- UI helpers ---------------- */
const messages = [
  { role: "system", content: "Você é um tutor de ingles que vai tirar duvidas dos alunos, seja claro e objetivo." }
];

function addMsg(text, who){
  const el = document.createElement('div');
  el.className = `msg ${who}`;
  el.textContent = text;
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
}

function addCTAPackages(packages){
  const el = document.createElement('div');
  el.className = 'msg bot';

  const txt = document.createElement('div');
  txt.textContent = 'Você atingiu o limite mensal. Deseja liberar mais mensagens?';

  const wrap = document.createElement('div');
  wrap.className = 'cta-wrap';

  (packages || []).forEach(p => {
    if (!p?.url) return;
    const a = document.createElement('a');
    a.className = 'cta-btn';
    a.href = p.url;
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.textContent = p.label || 'Comprar';
    wrap.appendChild(a);
  });

  el.appendChild(txt);
  el.appendChild(wrap);
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
}

/* ---------------- QUOTA ---------------- */
async function atualizarQuota(){
  try {
    const t = getToken();
    const url = t ? `${QUOTA_URL}?t=${encodeURIComponent(t)}` : QUOTA_URL;
    const r = await fetch(url, { credentials: 'include' });
    if (!r.ok) {
      if (r.status === 401) { badge.textContent = 'entre pelo Canvas'; return; }
      throw new Error('quota not ok');
    }
    const { remaining, limit } = await r.json();
    badge.textContent = `Restantes: ${remaining} / ${limit}`;
    if (remaining <= 20) { badge.style.background = '#fff7ed'; badge.style.color = '#9a3412'; }
    else { badge.style.background = '#f1f5f9'; badge.style.color = '#0f172a'; }
  } catch {
    badge.textContent = 'quota indisponível';
  }
}

/* ---------------- SEND ---------------- */
async function send(){
  const text = input.value.trim();
  if(!text) return;
  addMsg(text, 'user');
  input.value = '';
  btn.disabled = true;

  messages.push({ role: "user", content: text });

  let data;
  try {
    const t = getToken();
    const body = { messages };
    if (t) body.t = t; // envia token de fallback no body

    const res = await fetch(CHAT_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      credentials: "include",
      body: JSON.stringify(body)
    });

    if (res.status === 429) {
      const j = await res.json().catch(() => ({}));
      addMsg(`Limite mensal atingido (${j.used}/${j.limit}).`, 'bot');
      if (Array.isArray(j.packages) && j.packages.length > 0) addCTAPackages(j.packages);
      btn.disabled = false;
      await atualizarQuota();
      return;
    }

    if(!res.ok){
      const j = await res.json().catch(() => ({}));
      console.error('Falha /api/chat', res.status, j);
      addMsg("Erro no servidor. Tente novamente.", 'bot');
      btn.disabled = false;
      return;
    }

    data = await res.json();
  } catch (err) {
    console.error('Erro de rede /api/chat:', err);
    addMsg("Erro de rede. Tente novamente.", 'bot');
    btn.disabled = false;
    return;
  }

  const reply = data.reply || "(sem conteúdo)";
  addMsg(reply, 'bot');
  messages.push({ role: "assistant", content: reply });

  btn.disabled = false;
  atualizarQuota();
}

btn.onclick = send;
input.addEventListener('keydown', e => { if(e.key==='Enter') send(); });

/* ---------- Correções de teclado/viewport no mobile (iframe) ---------- */
// Ajusta a área visível quando o teclado abre no iOS (visualViewport)
(function fixViewportForKeyboard(){
  const vv = window.visualViewport;
  if (!vv) return;
  const onResize = () => {
    const h = vv.height;
    chat.style.maxHeight = Math.max(120, h - 160) + 'px';
    chat.scrollTop = chat.scrollHeight;
  };
  vv.addEventListener('resize', onResize);
  vv.addEventListener('scroll', onResize);
})();

// Mantém a última mensagem visível ao focar o input
input.addEventListener('focus', () => {
  setTimeout(() => {
    chat.scrollTop = chat.scrollHeight;
    input.scrollIntoView({ block: 'nearest' });
  }, 250);
});

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', () => {
  captureTokenFromURL();   // pega ?t=... (se vier)
  atualizarQuota();
});
/* ===== DEBUG TEMPORÁRIO (remova depois que testar) ===== */

// 1) Banner fixo no rodapé mostrando se o token está salvo
(function debugBanner(){
  try{
    const t = (localStorage.getItem('lti_token') || '').toString();
    const has = !!t;
    const tail = has ? t.slice(-8) : 'none';

    const bar = document.createElement('div');
    bar.id = 'debug-token-bar';
    bar.style.cssText = [
      'position:sticky','bottom:0','left:0','right:0',
      'background:#0b1f1e','color:#81D8D0','padding:6px 10px',
      'font:12px system-ui','border-top:1px solid #243041','z-index:9999'
    ].join(';');

    bar.textContent = has
      ? `Mobile auth: token OK (…${tail})`
      : 'Mobile auth: sem token; abra pelo Módulo novamente';

    document.body.appendChild(bar);
  }catch(e){}
})();
</script>
</body>
</html>
