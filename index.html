<!doctype html>
<html lang="pt-br">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Chat Canvas + GPT</title>
<style>
  :root {
    --tiffany:#81D8D0;
    --bg:#0f1216;
    --card:#151a21;
    --text:#eaf2fb;
    --muted:#9fb3c8;
    --border:#243041;
  }

  * , *::before, *::after {
    box-sizing: border-box;
  }

  html, body {
    height: 100%;
  }

  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font: 16px/1.45 system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  }

  .wrap {
    width: 100%;
    max-width: 1100px;      /* mais largo no desktop */
    margin: 0 auto;
    padding: 24px 24px 32px;
    height: 100%;
    display: flex;
  }

  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    display: flex;
    flex-direction: column;
    width: 100%;
    min-height: 0; /* importante pra funcionar bem em iframe */
  }

  .header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .left {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--tiffany);
  }

  .title {
    font-weight: 600;
  }

  .badge {
    padding: 6px 10px;
    border-radius: 999px;
    background: #f1f5f9;
    color: #0f172a;
    font: 500 12px system-ui;
    box-shadow: 0 1px 3px rgba(0,0,0,.08);
    white-space: nowrap;
  }

  /* ----- abas (Chat / Speaking) ----- */
  .tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    gap: 4px;
    padding: 0 8px;
    flex-shrink: 0;
  }

  .tab-btn {
    border: 0;
    background: transparent;
    color: var(--muted);
    padding: 10px 14px;
    cursor: pointer;
    font-weight: 500;
    border-radius: 999px;
    margin: 6px 4px;
  }

  .tab-btn.active {
    background: rgba(129,216,208,0.12);
    color: var(--text);
    border: 1px solid var(--tiffany);
  }

  .panel {
    display: none;
    flex-direction: column;
    flex: 1 1 auto;
    min-height: 0;
  }

  .panel.active {
    display: flex;
  }

  /* ----- chat ----- */
  .chat {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto;
    flex: 1 1 auto;   /* ocupa o espa√ßo entre header e footer */
    min-height: 0;    /* ESSENCIAL pra n√£o ‚Äúestourar‚Äù dentro do flex */
  }

  .msg {
    max-width: 80%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .user {
    align-self: flex-end;
    background: rgba(129,216,208,.12);
  }

  .bot {
    align-self: flex-start;
    background: #0d1117;
  }

  .footer {
    display: flex;
    gap: 8px;
    padding: 12px 12px 14px;
    border-top: 1px solid var(--border);
    align-items: center;
    flex-shrink: 0;
  }

  input, button {
    font: inherit;
  }

  input {
    flex: 1;
    background: #0d1117;
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 10px;
    font-size: 16px; /* >=16px evita zoom no iOS */
    min-width: 0;    /* evita estourar no mobile */
  }

  button {
    background: var(--tiffany);
    border: 0;
    border-radius: 10px;
    padding: 12px 16px;
    color: #0b1f1e;
    cursor: pointer;
    font-weight: 700;
    white-space: nowrap;
  }

  button:disabled {
    opacity: .6;
    cursor: not-allowed;
  }

  /* CTAs de upgrade */
  .cta-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-top: 6px;
  }

  .cta-btn {
    display: inline-block;
    background: #81D8D0;
    color: #0b1f1e;
    padding: 8px 14px;
    border-radius: 999px;
    border: 0;
    text-decoration: none;
    font-weight: 700;
    box-shadow: 0 1px 3px rgba(0,0,0,.1);
  }

  .cta-btn:hover {
    filter: brightness(0.95);
  }

  /* ----- speaking lab ----- */
  .speaking-wrap {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow-y: auto;
    flex: 1 1 auto;
    min-height: 0;
  }

  .speaking-card {
    background: #0d1117;
    border-radius: 12px;
    border: 1px solid var(--border);
    padding: 12px 14px;
    font-size: 14px;
    color: var(--muted);
  }

  .speaking-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .speaking-btn {
    background: rgba(129,216,208,.15);
    color: var(--text);
    border-radius: 999px;
    padding: 8px 14px;
    border: 1px solid var(--tiffany);
    cursor: pointer;
    font-size: 14px;
  }

  .speaking-btn:disabled {
    opacity: .6;
    cursor: not-allowed;
  }

  .speaking-status {
    font-size: 13px;
    color: var(--muted);
  }

  .speaking-audio {
    margin-top: 8px;
  }

  /* Ajustes para telas menores (mobile) */
  @media (max-width: 600px) {
    .wrap {
      padding: 8px;
    }
    .header {
      padding: 10px 12px;
    }
    .footer {
      padding: 10px 10px 12px;
      gap: 6px;
    }
    input {
      padding: 10px 8px;
      font-size: 15px;
    }
    button {
      padding: 10px 12px;
      font-size: 15px;
    }
    .msg {
      max-width: 90%;
    }
  }
</style>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="left">
          <span class="dot"></span>
          <div class="title">IA English Journey</div>
        </div>
        <div id="quota-badge" class="badge">carregando‚Ä¶</div>
      </div>

      <!-- abas -->
      <div class="tabs">
        <button id="tab-chat" class="tab-btn active">Chat</button>
        <button id="tab-speaking" class="tab-btn">Speaking Lab</button>
      </div>

      <!-- painel CHAT -->
      <div id="panel-chat" class="panel active">
        <div id="chat" class="chat"></div>
        <div class="footer">
          <input id="input" placeholder="Ask your questions..." autocomplete="off" autocapitalize="sentences" />
          <button id="send">Enviar</button>
        </div>
      </div>

      <!-- painel SPEAKING -->
      <div id="panel-speaking" class="panel">
        <div class="speaking-wrap">
          <div class="speaking-card">
            <strong>Speaking Lab (beta)</strong><br>
            Grave frases em ingl√™s para praticar sua pron√∫ncia.
            <br><br>
            Exemplo: <em>"Do you speak Spanish, my friend?"</em><br>
            No futuro, esta √°rea vai enviar seu √°udio para a IA, corrigir a frase e devolver um feedback em texto e voz.
            Por enquanto, √© um teste de grava√ß√£o local para checar se o microfone funciona dentro do Canvas.
          </div>

          <div class="speaking-card">
            <div class="speaking-actions">
              <button id="rec-start" class="speaking-btn">üéôÔ∏è Gravar</button>
              <button id="rec-stop" class="speaking-btn" disabled>‚èπÔ∏è Parar</button>
            </div>
            <div id="speech-status" class="speaking-status">
              Pronto para gravar. Quando terminar, voc√™ poder√° ouvir sua pr√≥pria grava√ß√£o.
            </div>
            <audio id="speech-playback" class="speaking-audio" controls style="display:none"></audio>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const CHAT_URL  = '/api/chat';
  const QUOTA_URL = '/api/quota';

  // hist√≥rico salvo no navegador do aluno
  const LOCAL_HISTORY_KEY = 'ia_english_history_v1';

  /* ---------- TOKEN FALLBACK (funciona em iframe iOS/Android) ---------- */
  function captureTokenFromURL(){
    try {
      const u = new URL(window.location.href);
      const t = u.searchParams.get('t');
      if (t) {
        localStorage.setItem('lti_token', t);
        // remove ?t da URL sem recarregar
        u.searchParams.delete('t');
        window.history.replaceState({}, '', u.toString());
      }
      return t;
    } catch {
      return null;
    }
  }

  function getToken(){
    try {
      return localStorage.getItem('lti_token') || captureTokenFromURL() || null;
    } catch {
      return captureTokenFromURL() || null;
    }
  }

  const SYSTEM_MESSAGES = [
    {
      role: "system",
      content: "Voc√™ √© um tutor de ingl√™s que vai tirar d√∫vidas dos alunos, seja claro e objetivo."
    }
  ];

  async function init() {
    const chat        = document.getElementById('chat');
    const input       = document.getElementById('input');
    const btn         = document.getElementById('send');
    const badge       = document.getElementById('quota-badge');

    const tabChat     = document.getElementById('tab-chat');
    const tabSpeaking = document.getElementById('tab-speaking');
    const panelChat   = document.getElementById('panel-chat');
    const panelSpeak  = document.getElementById('panel-speaking');

    const recStart    = document.getElementById('rec-start');
    const recStop     = document.getElementById('rec-stop');
    const speechStatus= document.getElementById('speech-status');
    const speechAudio = document.getElementById('speech-playback');

    if (!chat || !input || !btn || !badge) {
      console.error('Elementos do chat n√£o encontrados');
      return;
    }

    // estado da conversa que vai para a API
    const messages = [...SYSTEM_MESSAGES];

    function addMsg(text, who){
      const el = document.createElement('div');
      el.className = `msg ${who}`;
      el.textContent = text;
      chat.appendChild(el);
      chat.scrollTop = chat.scrollHeight;
    }

    // ---- hist√≥rico local (navegador) ----
    function saveLocalHistory(role, content) {
      try {
        const raw = localStorage.getItem(LOCAL_HISTORY_KEY);
        let arr = [];
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) arr = parsed;
        }
        arr.push({ role, content, ts: Date.now() });
        if (arr.length > 200) {
          arr = arr.slice(arr.length - 200); // limita tamanho
        }
        localStorage.setItem(LOCAL_HISTORY_KEY, JSON.stringify(arr));
      } catch (e) {
        console.error('Erro ao salvar hist√≥rico local:', e);
      }
    }

    function loadLocalHistory() {
      try {
        const raw = localStorage.getItem(LOCAL_HISTORY_KEY);
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return;

        arr.forEach(m => {
          if (!m || typeof m.content !== 'string') return;
          const who = m.role === 'user' ? 'user' : 'bot';
          addMsg(m.content, who);
          // hidrata mensagens pra IA ter contexto tamb√©m
          const role = who === 'user' ? 'user' : 'assistant';
          messages.push({ role, content: m.content });
        });
      } catch (e) {
        console.error('Erro ao carregar hist√≥rico local:', e);
      }
    }

    /* ---------------- QUOTA ---------------- */
    async function atualizarQuota(){
      try {
        const t = getToken();
        const url = t ? `${QUOTA_URL}?t=${encodeURIComponent(t)}` : QUOTA_URL;
        const r = await fetch(url, { credentials: 'include' });
        if (!r.ok) {
          if (r.status === 401) {
            badge.textContent = 'entre pelo Canvas';
            return;
          }
          throw new Error('quota not ok');
        }
        const { remaining, limit } = await r.json();
        badge.textContent = `Restantes: ${remaining} / ${limit}`;
        if (remaining <= 20) {
          badge.style.background = '#fff7ed';
          badge.style.color = '#9a3412';
        } else {
          badge.style.background = '#f1f5f9';
          badge.style.color = '#0f172a';
        }
      } catch (e) {
        console.error('Erro ao buscar quota:', e);
        badge.textContent = 'quota indispon√≠vel';
      }
    }

    /* ---------------- SEND (chat texto) ---------------- */
    async function send(){
      const text = input.value.trim();
      if(!text) return;

      addMsg(text, 'user');
      saveLocalHistory('user', text);
      input.value = '';
      btn.disabled = true;

      messages.push({ role: "user", content: text });

      let data;
      try {
        const t = getToken();
        const body = { messages };
        if (t) body.t = t; // envia token de fallback no body

        const res = await fetch(CHAT_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          credentials: "include",
          body: JSON.stringify(body)
        });

        if (res.status === 429) {
          const j = await res.json().catch(() => ({}));
          addMsg(`Limite mensal atingido (${j.used}/${j.limit}).`, 'bot');
          if (Array.isArray(j.packages) && j.packages.length > 0) {
            const el = document.createElement('div');
            el.className = 'msg bot';
            const wrap = document.createElement('div');
            wrap.className = 'cta-wrap';
            j.packages.forEach(p => {
              if (!p?.url) return;
              const a = document.createElement('a');
              a.className = 'cta-btn';
              a.href = p.url;
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              a.textContent = p.label || 'Comprar';
              wrap.appendChild(a);
            });
            el.appendChild(wrap);
            chat.appendChild(el);
            chat.scrollTop = chat.scrollHeight;
          }
          btn.disabled = false;
          await atualizarQuota();
          return;
        }

        if(!res.ok){
          const j = await res.json().catch(() => ({}));
          console.error('Falha /api/chat', res.status, j);
          addMsg("Erro no servidor. Tente novamente.", 'bot');
          btn.disabled = false;
          return;
        }

        data = await res.json();
      } catch (err) {
        console.error('Erro de rede /api/chat:', err);
        addMsg("Erro de rede. Tente novamente.", 'bot');
        btn.disabled = false;
        return;
      }

      const reply = data.reply || "(sem conte√∫do)";
      addMsg(reply, 'bot');
      saveLocalHistory('assistant', reply);
      messages.push({ role: "assistant", content: reply });

      btn.disabled = false;
      atualizarQuota();
    }

    // handlers do chat
    btn.addEventListener('click', send);
    input.addEventListener('keydown', e => { if(e.key === 'Enter') send(); });

    input.addEventListener('focus', () => {
      setTimeout(() => {
        chat.scrollTop = chat.scrollHeight;
      }, 250);
    });

    // ---------- abas (Chat / Speaking) ----------
    function activateTab(which) {
      if (!panelChat || !panelSpeak || !tabChat || !tabSpeaking) return;
      if (which === 'chat') {
        panelChat.classList.add('active');
        panelSpeak.classList.remove('active');
        tabChat.classList.add('active');
        tabSpeaking.classList.remove('active');
      } else {
        panelChat.classList.remove('active');
        panelSpeak.classList.add('active');
        tabChat.classList.remove('active');
        tabSpeaking.classList.add('active');
      }
    }

    tabChat?.addEventListener('click', () => activateTab('chat'));
    tabSpeaking?.addEventListener('click', () => activateTab('speaking'));

    // ---------- Speaking Lab: teste de grava√ß√£o local ----------
    let mediaRecorder = null;
    let chunks = [];
    let isRecording = false;

    async function startRecording(){
      if (!recStart || !recStop || !speechStatus || !speechAudio) return;
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          speechStatus.textContent = 'Seu navegador n√£o suporta grava√ß√£o de √°udio.';
          return;
        }

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];
        isRecording = true;

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) {
            chunks.push(e.data);
          }
        };

        mediaRecorder.onstop = () => {
          try {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            speechAudio.src = url;
            speechAudio.style.display = 'block';
            speechStatus.textContent = 'Grava√ß√£o conclu√≠da. Ou√ßa sua pron√∫ncia. Em breve, este √°udio ser√° enviado para a IA para corre√ß√£o.';
          } catch (err) {
            console.error('Erro ao processar √°udio gravado:', err);
            speechStatus.textContent = 'Erro ao processar a grava√ß√£o.';
          }
        };

        mediaRecorder.start();
        speechStatus.textContent = 'Gravando... fale em ingl√™s. Clique em Parar quando terminar.';
        recStart.disabled = true;
        recStop.disabled = false;
      } catch (err) {
        console.error('Erro ao iniciar grava√ß√£o:', err);
        speechStatus.textContent = 'N√£o foi poss√≠vel acessar o microfone. Verifique as permiss√µes do navegador.';
      }
    }

    function stopRecording(){
      if (!recStart || !recStop || !speechStatus) return;
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        recStart.disabled = false;
        recStop.disabled = true;
        // TODO: aqui no futuro vamos enviar o blob para /api/speaking
      }
    }

    recStart?.addEventListener('click', startRecording);
    recStop?.addEventListener('click', stopRecording);

    // init fluxo
    captureTokenFromURL();
    loadLocalHistory();   // desenha hist√≥rico salvo no navegador
    atualizarQuota();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>
