<!doctype html>
<html lang="pt-br">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat Canvas + GPT</title>
<style>
  :root{--tiffany:#81D8D0;--bg:#0f1216;--card:#151a21;--text:#eaf2fb;--muted:#9fb3c8;--border:#243041}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}

  /* layout desktop */
  .grid { display:grid; grid-template-columns:280px 1fr; gap:16px; }

  /* cartão do chat */
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;justify-content:space-between}
  .left{display:flex;gap:8px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--tiffany)}
  .title{font-weight:600}
  .badge{padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#0f172a;font:500 12px system-ui;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  .chat{padding:16px;display:flex;flex-direction:column;gap:10px;height:60vh;overflow:auto}
  .msg{max-width:80%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;white-space:pre-wrap}
  .user{align-self:flex-end;background:rgba(129,216,208,.12)}
  .bot{align-self:flex-start;background:#0d1117}
  .footer{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
  input,button{font:inherit}
  input{flex:1;background:#0d1117;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px}
  button{background:var(--tiffany);border:0;border-radius:10px;padding:10px 16px;color:#0b1f1e;cursor:pointer;font-weight:700}
  button:disabled{opacity:.6;cursor:not-allowed}
  .small-btn {
    background:#223044; color:#eaf2fb; border:1px solid var(--border);
    border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer;
  }

  /* botões de upgrade */
  .cta-wrap{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:6px}
  .cta-btn{
    display:inline-block;background:#81D8D0;color:#0b1f1e;
    padding:8px 14px;border-radius:999px;border:0;text-decoration:none;
    font-weight:700; box-shadow:0 1px 3px rgba(0,0,0,.1)
  }
  .cta-btn:hover{filter:brightness(0.95)}

  /* sidebar/histórico (desktop) */
  .sidebar {
    background: var(--card); border:1px solid var(--border); border-radius:16px;
    padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.25);
    height:60vh; overflow:auto;
  }
  .sidebar header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .sidebar h3 { margin: 6px 0 0; font-size:14px; color: var(--muted); }
  .hist-item {
    border:1px solid var(--border); border-radius:10px; padding:8px; margin-bottom:8px;
    cursor:pointer; background:#0d1117;
  }
  .hist-item:hover { filter: brightness(1.05); }
  .hist-q { color:#bcd2e8; font-weight:600; font-size:13px; margin-bottom:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .hist-a { color:#9fb3c8; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* ====== MOBILE: histórico vira drawer ====== */
  .drawer-toggle{ display:none } /* botão só no mobile */
  .drawer { display:none }       /* container do drawer */
  .backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.5);
    opacity:0; pointer-events:none; transition:opacity .2s ease;
  }
  .drawer-panel{
    position:fixed; top:0; right:0; height:100vh; width:86%;
    max-width:380px; background:var(--card); border-left:1px solid var(--border);
    transform:translateX(100%); transition:transform .25s ease;
    display:flex; flex-direction:column; padding:12px; z-index:50;
  }
  .drawer-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .drawer.open .backdrop{ opacity:1; pointer-events:auto }
  .drawer.open .drawer-panel{ transform:translateX(0) }

  @media (max-width: 960px){
    .grid{ display:block }            /* esconde sidebar fixa */
    .sidebar{ display:none }
    .drawer-toggle{ display:inline-block }  /* mostra botão Histórico */
    .drawer{ display:block }
  }
</style>
<body>
  <div class="wrap">
    <!-- Drawer (mobile) -->
    <div id="drawer" class="drawer" aria-hidden="true">
      <div id="backdrop" class="backdrop"></div>
      <aside class="drawer-panel" role="dialog" aria-modal="true" aria-label="Histórico">
        <div class="drawer-header">
          <h3 style="margin:6px 0 0; font-size:14px; color:var(--muted)">Histórico (mês)</h3>
          <div style="display:flex; gap:8px">
            <button id="clear-history-m" class="small-btn">Limpar</button>
            <button id="close-drawer" class="small-btn">Fechar</button>
          </div>
        </div>
        <div id="history-list-m" style="overflow:auto"></div>
      </aside>
    </div>

    <div class="grid">
      <!-- Sidebar (desktop) -->
      <aside class="sidebar">
        <header>
          <h3>Histórico (mês)</h3>
          <button id="clear-history" class="small-btn">Limpar</button>
        </header>
        <div id="history-list"></div>
      </aside>

      <!-- Chat -->
      <div class="card">
        <div class="header">
          <div class="left">
            <span class="dot"></span>
            <div class="title">IA English Journey</div>
          </div>
          <div style="display:flex; align-items:center; gap:8px">
            <button id="open-drawer" class="small-btn drawer-toggle">Histórico</button>
            <div id="quota-badge" class="badge">carregando…</div>
          </div>
        </div>
        <div id="chat" class="chat"></div>
        <div class="footer">
          <input id="input" placeholder="Digite sua pergunta..." />
          <button id="send">Enviar</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* URLs relativas + cookies LTI */
const CHAT_URL    = '/api/chat';
const QUOTA_URL   = '/api/quota';
const HISTORY_URL = '/api/history';

const chat   = document.getElementById('chat');
const input  = document.getElementById('input');
const btn    = document.getElementById('send');
const badge  = document.getElementById('quota-badge');

/* Drawer refs */
const drawer       = document.getElementById('drawer');
const backdrop     = document.getElementById('backdrop');
const openDrawer   = document.getElementById('open-drawer');
const closeDrawer  = document.getElementById('close-drawer');
const histListMob  = document.getElementById('history-list-m');
const clearBtnMob  = document.getElementById('clear-history-m');

/* Sidebar desktop refs */
const histList = document.getElementById('history-list');
const clearBtn = document.getElementById('clear-history');

const messages = [
  { role: "system", content: "Você é um tutor de ingles que vai tirar duvidas dos alunos, seja claro e objetivo." }
];

function addMsg(text, who){
  const el = document.createElement('div');
  el.className = `msg ${who}`;
  el.textContent = text;
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
}

/* Upgrade buttons */
function addCTAPackages(packages){
  const el = document.createElement('div');
  el.className = 'msg bot';
  const txt = document.createElement('div');
  txt.textContent = 'Você atingiu o limite mensal. Deseja liberar mais mensagens?';
  const wrap = document.createElement('div'); wrap.className = 'cta-wrap';

  (packages || []).forEach(p => {
    if (!p?.url) return;
    const a = document.createElement('a');
    a.className = 'cta-btn'; a.href = p.url; a.target = '_blank'; a.rel = 'noopener noreferrer';
    a.textContent = p.label || 'Comprar';
    wrap.appendChild(a);
  });

  el.appendChild(txt); el.appendChild(wrap);
  chat.appendChild(el); chat.scrollTop = chat.scrollHeight;
}

/* Quota */
async function atualizarQuota(){
  try {
    const r = await fetch(QUOTA_URL, { credentials: 'include' });
    if (r.status === 401) { badge.textContent = 'entre pelo Canvas'; return; }
    if (!r.ok) throw new Error('quota not ok');
    const { remaining, limit } = await r.json();
    badge.textContent = `Restantes: ${remaining} / ${limit}`;
    if (remaining <= 20) { badge.style.background = '#fff7ed'; badge.style.color = '#9a3412'; }
    else { badge.style.background = '#f1f5f9'; badge.style.color = '#0f172a'; }
  } catch { badge.textContent = 'quota indisponível'; }
}

/* ---------- Histórico ---------- */
function fmtTime(ts){
  try { const d = new Date(ts);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${dd}/${mm} ${hh}:${mi}`;
  } catch { return ''; }
}

function makeHistItem(it){
  const div = document.createElement('div'); div.className = 'hist-item'; div.title = new Date(it.ts).toLocaleString();
  const q = document.createElement('div'); q.className = 'hist-q'; q.textContent = `(${fmtTime(it.ts)}) ${it.q || ''}`;
  const a = document.createElement('div'); a.className = 'hist-a'; a.textContent = it.a || '';
  div.appendChild(q); div.appendChild(a);
  div.addEventListener('click', () => { if (it.q) addMsg(it.q,'user'); if (it.a) addMsg(it.a,'bot'); chat.scrollTop = chat.scrollHeight; });
  return div;
}

function renderHistory(items){
  // desktop
  if (histList){
    histList.innerHTML = '';
    if (!items || items.length === 0){
      histList.innerHTML = '<div style="color:var(--muted);font-size:12px;">Sem histórico neste mês.</div>';
    } else {
      items.forEach(it => histList.appendChild(makeHistItem(it)));
    }
  }
  // mobile drawer
  if (histListMob){
    histListMob.innerHTML = '';
    if (!items || items.length === 0){
      histListMob.innerHTML = '<div style="color:var(--muted);font-size:12px;">Sem histórico neste mês.</div>';
    } else {
      items.forEach(it => histListMob.appendChild(makeHistItem(it)));
    }
  }
}

async function loadHistory(){
  try{
    const r = await fetch(HISTORY_URL, { credentials: 'include' });
    if (r.status === 401){ renderHistory([]); return; }
    const j = await r.json();
    renderHistory(j.items || []);
  }catch(e){ console.error('history load fail', e); renderHistory([]); }
}

async function clearHistory(){
  if (!confirm('Apagar seu histórico deste mês?')) return;
  try {
    await fetch(HISTORY_URL, { method:'DELETE', credentials:'include' });
    loadHistory();
  } catch (e) { console.error(e); }
}
if (clearBtn)  clearBtn.addEventListener('click', clearHistory);
if (clearBtnMob) clearBtnMob.addEventListener('click', clearHistory);

/* Drawer actions (mobile) */
function openHist(){ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); }
function closeHist(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }
if (openDrawer)  openDrawer.addEventListener('click', () => { openHist(); loadHistory(); });
if (closeDrawer) closeDrawer.addEventListener('click', closeHist);
if (backdrop)    backdrop.addEventListener('click', closeHist);

/* Envio */
async function send(){
  const text = input.value.trim();
  if(!text) return;
  addMsg(text, 'user');
  input.value = '';
  btn.disabled = true;

  messages.push({ role: "user", content: text });

  let data;
  try {
    const res = await fetch(CHAT_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      credentials: "include",
      body: JSON.stringify({ messages })
    });

    if (res.status === 429) {
      const j = await res.json().catch(() => ({}));
      addMsg(`Limite mensal atingido (${j.used}/${j.limit}).`, 'bot');
      if (Array.isArray(j.packages) && j.packages.length > 0) addCTAPackages(j.packages);
      btn.disabled = false;
      await atualizarQuota();
      return;
    }

    if(!res.ok){
      const j = await res.json().catch(() => ({}));
      console.error('Falha /api/chat', res.status, j);
      addMsg("Erro no servidor. Tente novamente.", 'bot');
      btn.disabled = false;
      return;
    }

    data = await res.json();
  } catch (err) {
    console.error('Erro de rede /api/chat:', err);
    addMsg("Erro de rede. Tente novamente.", 'bot');
    btn.disabled = false;
    return;
  }

  const reply = data.reply || "(sem conteúdo)";
  addMsg(reply, 'bot');
  messages.push({ role: "assistant", content: reply });

  btn.disabled = false;
  atualizarQuota();
  loadHistory(); // atualiza histórico após cada resposta
}

btn.onclick = send;
input.addEventListener('keydown', e => { if(e.key==='Enter') send(); });

document.addEventListener('DOMContentLoaded', () => {
  atualizarQuota();
  loadHistory();
});
</script>
</body>
</html>
