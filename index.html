<!doctype html>
<html lang="pt-br">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Chat Canvas + GPT</title>
<style>
  :root {
    --tiffany:#81D8D0;
    --bg:#0f1216;
    --card:#151a21;
    --text:#eaf2fb;
    --muted:#9fb3c8;
    --border:#243041;
  }

  * , *::before, *::after {
    box-sizing: border-box;
  }

  html, body {
    height: 100%;
  }

  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font: 16px/1.45 system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  }

  .wrap {
    width: 100%;
    max-width: 1100px;      /* mais largo no desktop */
    margin: 0 auto;
    padding: 24px 24px 32px;
    height: 100%;
    display: flex;
  }

  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    display: flex;
    flex-direction: column;
    width: 100%;
    min-height: 0; /* importante pra funcionar bem em iframe */
  }

  .header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .left {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--tiffany);
  }

  .title {
    font-weight: 600;
  }

  .badge {
    padding: 6px 10px;
    border-radius: 999px;
    background: #f1f5f9;
    color: #0f172a;
    font: 500 12px system-ui;
    box-shadow: 0 1px 3px rgba(0,0,0,.08);
    white-space: nowrap;
  }

  .chat {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto;
    flex: 1 1 auto;   /* ocupa o espaço entre header e footer */
    min-height: 0;    /* ESSENCIAL pra não “estourar” dentro do flex */
  }

  .msg {
    max-width: 80%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .user {
    align-self: flex-end;
    background: rgba(129,216,208,.12);
  }

  .bot {
    align-self: flex-start;
    background: #0d1117;
  }

  .footer {
    display: flex;
    gap: 8px;
    padding: 12px 12px 14px;
    border-top: 1px solid var(--border);
    align-items: center;
    flex-shrink: 0;
  }

  input, button {
    font: inherit;
  }

  input {
    flex: 1;
    background: #0d1117;
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 10px;
    font-size: 16px; /* >=16px evita zoom no iOS */
    min-width: 0;    /* evita estourar no mobile */
  }

  button {
    background: var(--tiffany);
    border: 0;
    border-radius: 10px;
    padding: 12px 16px;
    color: #0b1f1e;
    cursor: pointer;
    font-weight: 700;
    white-space: nowrap;
  }

  button:disabled {
    opacity: .6;
    cursor: not-allowed;
  }

  /* CTAs de upgrade */
  .cta-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-top: 6px;
  }

  .cta-btn {
    display: inline-block;
    background: #81D8D0;
    color: #0b1f1e;
    padding: 8px 14px;
    border-radius: 999px;
    border: 0;
    text-decoration: none;
    font-weight: 700;
    box-shadow: 0 1px 3px rgba(0,0,0,.1);
  }

  .cta-btn:hover {
    filter: brightness(0.95);
  }

  /* Ajustes para telas menores (mobile) */
  @media (max-width: 600px) {
    .wrap {
      padding: 8px;
    }
    .header {
      padding: 10px 12px;
    }
    .footer {
      padding: 10px 10px 12px;
      gap: 6px;
    }
    input {
      padding: 10px 8px;
      font-size: 15px;
    }
    button {
      padding: 10px 12px;
      font-size: 15px;
    }
    .msg {
      max-width: 90%;
    }
  }
</style>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="left">
          <span class="dot"></span>
          <div class="title">IA English Journey</div>
        </div>
        <div id="quota-badge" class="badge">carregando…</div>
      </div>
      <div id="chat" class="chat"></div>
      <div class="footer">
        <input id="input" placeholder="Ask your questions..." autocomplete="off" autocapitalize="sentences" />
        <button id="send">Enviar</button>
      </div>
    </div>
  </div>

<script>
const CHAT_URL    = '/api/chat';
const QUOTA_URL   = '/api/quota';
const HISTORY_URL = '/api/history';

const chat  = document.getElementById('chat');
const input = document.getElementById('input');
const btn   = document.getElementById('send');
const badge = document.getElementById('quota-badge');

/* ---------- TOKEN FALLBACK (funciona em iframe iOS/Android) ---------- */
function captureTokenFromURL(){
  const u = new URL(window.location.href);
  const t = u.searchParams.get('t');
  if (t) {
    localStorage.setItem('lti_token', t);
    // (opcional) remove ?t da URL sem recarregar
    u.searchParams.delete('t');
    window.history.replaceState({}, '', u.toString());
  }
  return t;
}
function getToken(){
  return localStorage.getItem('lti_token') || captureTokenFromURL() || null;
}

/* ---------------- UI helpers ---------------- */
const messages = [
  { role: "system", content: "Você é um tutor de ingles que vai tirar duvidas dos alunos, seja claro e objetivo." }
];

function addMsg(text, who){
  const el = document.createElement('div');
  el.className = `msg ${who}`;
  el.textContent = text;
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
}

function addCTAPackages(packages){
  const el = document.createElement('div');
  el.className = 'msg bot';

  const txt = document.createElement('div');
  txt.textContent = 'Você atingiu o limite mensal. Deseja liberar mais mensagens?';

  const wrap = document.createElement('div');
  wrap.className = 'cta-wrap';

  (packages || []).forEach(p => {
    if (!p?.url) return;
    const a = document.createElement('a');
    a.className = 'cta-btn';
    a.href = p.url;
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.textContent = p.label || 'Comprar';
    wrap.appendChild(a);
  });

  el.appendChild(txt);
  el.appendChild(wrap);
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
}

/* ---------------- HISTÓRICO ---------------- */
async function loadHistory() {
  try {
    const t = getToken();
    const url = t ? `${HISTORY_URL}?t=${encodeURIComponent(t)}` : HISTORY_URL;

    const res = await fetch(url, {
      method: 'GET',
      credentials: 'include',
    });

    if (!res.ok) {
      // se 401 ou outro erro, só não mostra histórico
      return;
    }

    const data = await res.json().catch(() => ({}));
    const items = Array.isArray(data.items) ? data.items : [];

    // desenha as mensagens antigas na tela (mais antigas primeiro)
    items.forEach(m => {
      if (!m || typeof m.content !== 'string') return;
      const who = m.role === 'user' ? 'user' : 'bot';
      addMsg(m.content, who);
    });
  } catch (err) {
    console.error('Erro ao carregar histórico:', err);
  }
}

/* ---------------- QUOTA ---------------- */
async function atualizarQuota(){
  try {
    const t = getToken();
    const url = t ? `${QUOTA_URL}?t=${encodeURIComponent(t)}` : QUOTA_URL;
    const r = await fetch(url, { credentials: 'include' });
    if (!r.ok) {
      if (r.status === 401) { badge.textContent = 'entre pelo Canvas
