<!doctype html>
<html lang="pt-br">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat Canvas + GPT</title>
<style>
  :root{--tiffany:#81D8D0;--bg:#0f1216;--card:#151a21;--text:#eaf2fb;--muted:#9fb3c8;--border:#243041}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:800px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;justify-content:space-between}
  .left{display:flex;gap:8px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--tiffany)}
  .title{font-weight:600}
  .badge{padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#0f172a;font:500 12px system-ui;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  .chat{padding:16px;display:flex;flex-direction:column;gap:10px;height:60vh;overflow:auto}
  .msg{max-width:80%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;white-space:pre-wrap}
  .user{align-self:flex-end;background:rgba(129,216,208,.12)}
  .bot{align-self:flex-start;background:#0d1117}
  .footer{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
  input,button{font:inherit}
  input{flex:1;background:#0d1117;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px}
  button{background:var(--tiffany);border:0;border-radius:10px;padding:10px 16px;color:#0b1f1e;cursor:pointer;font-weight:700}
  button:disabled{opacity:.6;cursor:not-allowed}
</style>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="left"><span class="dot"></span><div class="title">Chat do Curso</div></div>
        <div id="quota-badge" class="badge">carregando…</div>
      </div>
      <div id="chat" class="chat"></div>
      <div class="footer">
        <input id="input" placeholder="Digite sua pergunta..." />
        <button id="send">Enviar</button>
      </div>
    </div>
  </div>

<script>
/*
  Importante:
  - Usamos URLs RELATIVAS para evitar CORS: '/api/chat' e '/api/quota'
  - Sempre enviamos credenciais para o cookie LTI: credentials: 'include'
*/
const CHAT_URL  = '/api/chat';
const QUOTA_URL = '/api/quota';

const chat  = document.getElementById('chat');
const input = document.getElementById('input');
const btn   = document.getElementById('send');
const badge = document.getElementById('quota-badge');

const messages = [
  { role: "system", content: "Você é um tutor de ingles que vai tirar duvidas dos alunos, seja claro e objetivo." }
];

function addMsg(text, who){
  const el = document.createElement('div');
  el.className = `msg ${who}`;
  el.textContent = text;
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
}

async function atualizarQuota(){
  try {
    const r = await fetch(QUOTA_URL, { credentials: 'include' });
    if (r.status === 401) { badge.textContent = 'entre pelo Canvas'; return; }
    if (!r.ok) throw new Error('quota not ok');
    const { remaining, limit } = await r.json();
    badge.textContent = `Restantes: ${remaining} / ${limit}`;
    if (remaining <= 20) { badge.style.background = '#fff7ed'; badge.style.color = '#9a3412'; }
    else { badge.style.background = '#f1f5f9'; badge.style.color = '#0f172a'; }
  } catch {
    badge.textContent = 'quota indisponível';
  }
}

async function send(){
  const text = input.value.trim();
  if(!text) return;
  addMsg(text, 'user');
  input.value = '';
  btn.disabled = true;

  messages.push({ role: "user", content: text });

  let data;
  try {
    const res = await fetch(CHAT_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      credentials: "include", // leva cookie lti_user
      body: JSON.stringify({ messages }) // sem streaming
    });

    if (res.status === 429) {
      const j = await res.json().catch(() => ({}));
      addMsg(`Limite mensal atingido (${j.used}/${j.limit}).`, 'bot');
      btn.disabled = false;
      await atualizarQuota();
      return;
    }

    if(!res.ok){
      const j = await res.json().catch(() => ({}));
      console.error('Falha /api/chat', res.status, j);
      addMsg("Erro no servidor. Tente novamente.", 'bot');
      btn.disabled = false;
      return;
    }

    data = await res.json();
  } catch (err) {
    console.error('Erro de rede /api/chat:', err);
    addMsg("Erro de rede. Tente novamente.", 'bot');
    btn.disabled = false;
    return;
  }

  const reply = data.reply || "(sem conteúdo)";
  addMsg(reply, 'bot');
  messages.push({ role: "assistant", content: reply });

  btn.disabled = false;
  atualizarQuota();
}

btn.onclick = send;
input.addEventListener('keydown', e => { if(e.key==='Enter') send(); });

// Carrega quota ao abrir
document.addEventListener('DOMContentLoaded', atualizarQuota);
</script>
</body>
</html>
